"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[8558],{75183:(e,t,n)=>{var r;n.d(t,{A:()=>O}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated",e.History="History",e.MetadataReferenceModified="MetadataReferenceModified",e.LabelChange="LabelChange"}(r||(r={}));const O=r},94021:(e,t,n)=>{var r;n.d(t,{A:()=>O}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.CROSSHAIR_TOOL_CENTER_CHANGED="CORNERSTONE_TOOLS_CROSSHAIR_TOOL_CENTER_CHANGED",e.VOLUMECROPPINGCONTROL_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPINGCONTROL_TOOL_CHANGED",e.VOLUMECROPPING_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPING_TOOL_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_CUT_MERGE_PROCESS_COMPLETED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",e.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.HISTORY_UNDO="CORNERSTONE_TOOLS_HISTORY_UNDO",e.HISTORY_REDO="CORNERSTONE_TOOLS_HISTORY_REDO",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(r||(r={}));const O=r},18682:(e,t,n)=>{var r;n.d(t,{A:()=>O}),function(e){e.Labelmap="Labelmap",e.Contour="Contour",e.Surface="Surface"}(r||(r={}));const O=r},84093:(e,t,n)=>{var r;n.d(t,{A:()=>O}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.Interpolate="interpolate",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.AddPreview="addPreview",e.ComputeInnerCircleRadius="computeInnerCircleRadius",e.GetStatistics="getStatistics",e.EnsureImageVolumeFor3DManipulation="ensureImageVolumeFor3DManipulation",e.EnsureSegmentationVolumeFor3DManipulation="ensureSegmentationVolumeFor3DManipulation"}(r||(r={}));const O=r},66452:(e,t,n)=>{var r,O;n.d(t,{i:()=>r,q:()=>O}),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e[e.Wheel=524288]="Wheel",e[e.Wheel_Primary=524289]="Wheel_Primary"}(r||(r={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(O||(O={}))},49892:(e,t,n)=>{var r;n.d(t,{A:()=>O}),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(r||(r={}));const O=r},10401:(e,t,n)=>{var r;n.d(t,{H:()=>r}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(r||(r={}))},99737:(e,t,n)=>{n.r(t),n.d(t,{AnnotationStyleStates:()=>o,ChangeTypes:()=>T.A,Events:()=>s.A,KeyboardBindings:()=>O.q,MouseBindings:()=>O.i,SegmentationRepresentations:()=>S.A,StrategyCallbacks:()=>c.A,Swipe:()=>E.H,ToolModes:()=>a.A,WorkerTypes:()=>I});var r,O=n(66452),a=n(49892);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(r||(r={}));const o=r;var i,s=n(94021),S=n(18682),E=n(10401),c=n(84093),T=n(75183);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",e.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",e.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",e.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",e.SURFACE_CLIPPING="Clipping Surfaces",e.COMPUTE_STATISTICS="Computing Statistics",e.INTERPOLATE_LABELMAP="Interpolating Labelmap",e.COMPUTE_LARGEST_BIDIRECTIONAL="Computing Largest Bidirectional",e.GENERATE_CONTOUR_SETS="Generating Contour Sets"}(i||(i={}));const I=i},78558:(e,t,n)=>{n.r(t),n.d(t,{default:()=>p});const r=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-rt"}').UU,O=`${r}.sopClassHandlerModule.dicom-rt`;var a=n(86326),o=n(76569),i=n(89806),s=n(5842);const{DicomMessage:S,DicomMetaDictionary:E}=s.Ay.data,c=s.Ay.data.Colors.dicomlab2RGB;async function T(e,t,n){const r=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),O=e.getActiveDataSource()[0],{bulkDataURI:a}=O.getConfig?.()||{},{dicomLoaderService:o}=r.exports;t.isLoaded=!0;let i=t.instance;if(a&&a.enabled)await async function(e,t){if(!e||!e.ROIContourSequence)return Promise.reject("Invalid instance object or ROIContourSequence");const n=new Map;for(const r of e.ROIContourSequence){const O=r.ReferencedROINumber;if(r&&r.ContourSequence)for(const a of r.ContourSequence){if(!a||!a.ContourData)return Promise.reject("Invalid Contour or ContourData");const r=a.ContourData;if(Array.isArray(r))n.has(O)?n.get(O).push(Promise.resolve(r)):n.set(O,[Promise.resolve(r)]);else{if(!r||!r.BulkDataURI)return Promise.reject(`Invalid ContourData: ${r}`);{const a=r.BulkDataURI;if(!t||!t.retrieve||!t.retrieve.bulkDataURI)return Promise.reject("Invalid datasource object or retrieve function");const o=t.retrieve.bulkDataURI({BulkDataURI:a,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID,SOPInstanceUID:e.SOPInstanceUID});n.has(O)?n.get(O).push(o):n.set(O,[o])}}}else n.set(O,[Promise.resolve([])])}const r=new Map;for(const[e,t]of n.entries())r.set(e,await Promise.allSettled(t));e.ROIContourSequence.forEach(e=>{try{const t=e.ReferencedROINumber,n=r.get(t);e.ContourSequence&&e.ContourSequence.forEach((e,t)=>{const r=n[t];if("fulfilled"===r.status)if(Array.isArray(r.value)&&r.value.every(Number.isFinite))e.ContourData=r.value;else{const t=new Uint8Array(r.value),n=(new TextDecoder).decode(t);"string"==typeof n&&n.includes("\\")?e.ContourData=n.split("\\").map(parseFloat):e.ContourData=[]}else console.error(r.reason)})}catch(e){console.error(e)}})}(i,O);else{const e=await o.findDicomDataPromise(t,null,n),r=S.readFile(e),O=E.naturalizeDataset(r.dict);O._meta=E.namifyDataset(r.meta),i=O}const{StructureSetROISequence:s,ROIContourSequence:c,RTROIObservationsSequence:T}=i,N={StructureSetLabel:i.StructureSetLabel,SeriesInstanceUID:i.SeriesInstanceUID,ROIContours:[],visible:!0,ReferencedSOPInstanceUIDsSet:new Set};for(let e=0;e<c.length;e++){const t=c[e],{ContourSequence:n}=t;if(!n)continue;const r=R(n),O=[];for(const e of r){const{ContourData:t,NumberOfContourPoints:n,ContourGeometricType:r,ContourImageSequence:a}=e,o=[];for(let e=0;e<3*n;e+=3)o.push({x:t[e],y:t[e+1],z:t[e+2]});const i=new Map([["CLOSED_PLANAR",!1],["OPEN_NONPLANAR",!1],["OPEN_PLANAR",!1],["POINT",!0]]);O.push({numberOfPoints:n,points:o,type:r,isSupported:i.get(r)??!1}),a?.ReferencedSOPInstanceUID&&N.ReferencedSOPInstanceUIDsSet.add(a?.ReferencedSOPInstanceUID)}I(N,s,T,t,O)}return N}function I(e,t,n,r,O){const a=t.find(e=>e.ROINumber===r.ReferencedROINumber),o={ROINumber:a.ROINumber,ROIName:a.ROIName,ROIGenerationAlgorithm:a.ROIGenerationAlgorithm,ROIDescription:a.ROIDescription,contourPoints:O,visible:!0,colorArray:[]};!function(e,t){let{ROIDisplayColor:n,RecommendedDisplayCIELabValue:r}=e;!n&&r&&(n=c(r));n&&(t.colorArray=[...n])}(r,o),n&&function(e,t,n){const r=t.find(e=>e.ReferencedROINumber===n);if(r){const{ObservationNumber:t,ROIObservationDescription:n,RTROIInterpretedType:O,ROIInterpreter:a}=r;e.RTROIObservations={ObservationNumber:t,ROIObservationDescription:n,RTROIInterpretedType:O,ROIInterpreter:a}}}(o,n,r.ReferencedROINumber),e.ROIContours.push(o)}function R(e){return Array.isArray(e)?e:[e]}const{sopClassDictionary:N}=o.Wp,_=[N.RTStructureSetStorage],l=new Set,u={};function d(e,t,n){const r=e[0],{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:S,SeriesDescription:E,SeriesNumber:c,SeriesDate:I,SOPClassUID:R,wadoRoot:N,wadoUri:d,wadoUriRoot:D}=r,A={Modality:"RTSTRUCT",loading:!1,isReconstructable:!1,displaySetInstanceUID:o.Wp.guid(),SeriesDescription:E,SeriesNumber:c,SeriesDate:I,SOPInstanceUID:S,SeriesInstanceUID:s,StudyInstanceUID:a,SOPClassHandlerId:O,SOPClassUID:R,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,structureSet:null,sopClassUids:_,instance:r,wadoRoot:N,wadoUriRoot:D,wadoUri:d,isOverlayDisplaySet:!0,label:E||`${i.A.t("Series")} ${c} - ${i.A.t("RTSTRUCT")}`};let C=r.ReferencedSeriesSequence;if(r.ReferencedFrameOfReferenceSequence&&!r.ReferencedSeriesSequence&&(r.ReferencedSeriesSequence=function(e){const t=[];return e.forEach(e=>{const{RTReferencedStudySequence:n}=e;n.forEach(e=>{const{RTReferencedSeriesSequence:n}=e;n.forEach(e=>{const n=[],{ContourImageSequence:r,SeriesInstanceUID:O}=e;r.forEach(e=>{n.push({ReferencedSOPInstanceUID:e.ReferencedSOPInstanceUID,ReferencedSOPClassUID:e.ReferencedSOPClassUID})});const a={SeriesInstanceUID:O,ReferencedInstanceSequence:n};t.push(a)})})}),t}(r.ReferencedFrameOfReferenceSequence),C=r.ReferencedSeriesSequence),!C)throw new Error("ReferencedSeriesSequence is missing for the RTSTRUCT");const f=C[0];A.referencedImages=r.ReferencedSeriesSequence.ReferencedInstanceSequence,A.referencedSeriesInstanceUID=f.SeriesInstanceUID;const{displaySetService:L}=t.services,U=L.getDisplaySetsForSeries(A.referencedSeriesInstanceUID);if(U&&0!==U.length){const e=U[0];A.referencedDisplaySetInstanceUID=e.displaySetInstanceUID,A.isReconstructable=e.isReconstructable}else{const{unsubscribe:e}=L.subscribe(L.EVENTS.DISPLAY_SETS_ADDED,({displaySetsAdded:t})=>{const n=t[0];n.SeriesInstanceUID===A.referencedSeriesInstanceUID&&(A.referencedDisplaySetInstanceUID=n.displaySetInstanceUID,A.isReconstructable=n.isReconstructable,e())})}return A.load=({headers:e,createSegmentation:r=!0})=>function(e,t,n,r,O=!0){const{SOPInstanceUID:a}=e,{segmentationService:o}=t.services;if((e.loading||e.isLoaded)&&u[a]&&l.has(e.displaySetInstanceUID))return u[a];e.loading=!0;const{unsubscribe:i}=o.subscribe(o.EVENTS.SEGMENTATION_LOADING_COMPLETE,t=>{t.rtDisplaySet?.displaySetInstanceUID===e.displaySetInstanceUID&&(l.add(e.displaySetInstanceUID),i())});return u[a]=new Promise(async(t,a)=>{try{if(!e.structureSet){const t=await T(n,e,r);e.structureSet=t}O&&await o.createSegmentationForRTDisplaySet(e),t()}catch(e){a(e)}finally{e.loading=!1}}),u[a]}(A,t,n,e,r),[A]}const D=function(e){const{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-rt",sopClassUids:_,getDisplaySetsFromSeries:e=>d(e,t,n)}]};var A=n(99737);const C=({commandsManager:e,servicesManager:t})=>{const n=t.services,{displaySetService:r,viewportGridService:O}=n,a={hydrateRTSDisplaySet:({displaySet:t,viewportId:n})=>{if("RTSTRUCT"!==t.Modality)throw new Error("Display set is not an RTSTRUCT");const a=r.getDisplaySetByUID(t.referencedDisplaySetInstanceUID);e.runCommand("updateStoredSegmentationPresentation",{displaySet:t,type:A.SegmentationRepresentations.Contour}),e.runCommand("updateStoredPositionPresentation",{viewportId:n,displaySetInstanceUIDs:[a.displaySetInstanceUID]}),O.setDisplaySetsForViewport({viewportId:n,displaySetInstanceUIDs:[a.displaySetInstanceUID]})}};return{actions:a,definitions:{hydrateRTSDisplaySet:{commandFn:a.hydrateRTSDisplaySet,storeContexts:[],options:{}}},defaultContext:"cornerstone-dicom-rt"}};function f(){return f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f.apply(null,arguments)}const L=a.lazy(()=>Promise.all([n.e(6563),n.e(1563),n.e(2345),n.e(7412),n.e(2108),n.e(7431),n.e(1447),n.e(7656),n.e(5349)]).then(n.bind(n,88414))),U=e=>a.createElement(a.Suspense,{fallback:a.createElement("div",null,"Loading...")},a.createElement(L,e)),p={id:r,getCommandsModule:C,getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-rt",component:r=>a.createElement(U,f({servicesManager:e,extensionManager:t,commandsManager:n},r))}],getSopClassHandlerModule:D}}}]);
//# sourceMappingURL=8558.bundle.416231b8be1f400fdb72.js.map